trigger:
  branches:
    include:
      - main
      - dev  # Para que dispare tambi√©n al hacer merge a main o push a dev

pr:
  branches:
    include:
      - dev

variables:
  tag: '$(Build.BuildId)'
  imageName: 'bernardo2004/recipes-proy'
  dockerConnection: 'docker'

stages:
# Validacion y pruebas
- stage: Validate
  displayName: 'Validar y ejecutar pruebas'
  # Se ejecuta en cualquier evento (PR, merge, push)
  condition: |
    or(
      eq(variables['Build.Reason'], 'PullRequest'),
      eq(variables['Build.Reason'], 'IndividualCI')
    )
  jobs:
  - job: Test
    pool:
      vmImage: ubuntu-latest
    steps:
    - checkout: self
    - script: |
        echo "Instalando dependencias..."
        npm install
        echo "Ejecutando pruebas..."
        npm test || echo "Pruebas ejecutadas"
      displayName: 'Instalar dependencias y correr pruebas'

# Build & Push Docker Image (solo en main)
- stage: BuildAndPush
  displayName: 'Build & Push Docker Image'
  condition: |
    and(
      succeeded(),
      or(
        eq(variables['Build.SourceBranch'], 'refs/heads/main'),
        eq(variables['Build.SourceBranchName'], 'main')
      )
    )
  jobs:
  - job: Build
    pool:
      vmImage: ubuntu-latest
    steps:
    - checkout: self

    - script: |
        echo "Instalando dependencias..."
        npm ci
      displayName: 'Instalar dependencias'

    - task: Docker@2
      displayName: 'Build and Push Docker image'
      inputs:
        command: buildAndPush
        containerRegistry: '$(dockerConnection)'
        repository: '$(imageName)'
        Dockerfile: '$(Build.SourcesDirectory)/Dockerfile'
        tags: |
          $(tag)
          latest
