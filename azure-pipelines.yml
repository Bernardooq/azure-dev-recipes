# Trigger para PRs hacia main
pr:
  branches:
    include:
      - main
      - dev

# Trigger para pushes directos a main (cuando se mergea el PR)
trigger:
  branches:
    include:
      - main

variables:
  tag: '$(Build.BuildId)'
  imageName: 'bernardo2004/recipes-proy'
  dockerConnection: 'docker'

stages:
# Stage 1: Validación y pruebas (solo en PRs)
- stage: Validate
  displayName: 'Validar y ejecutar pruebas'
  condition: eq(variables['Build.Reason'], 'PullRequest')
  jobs:
    - job: Test
      displayName: 'Ejecutar pruebas'
      pool:
        vmImage: ubuntu-latest
      steps:
        - checkout: self

        - script: |
            echo "Instalando dependencias..."
            npm install
            echo "Ejecutando pruebas..."
#            npm test
          displayName: 'Instalar dependencias y correr pruebas'

# Stage 2: Build & Push Docker (solo en main después del merge)
- stage: BuildAndPush
  dependsOn: Validate
  displayName: 'Build & Push Docker Image'
  condition: |
    and(
      ne(variables['Build.Reason'], 'PullRequest'),
      eq(variables['Build.SourceBranch'], 'refs/heads/main')
    )
  jobs:
    - job: Build
      displayName: 'Construir y subir imagen Docker'
      pool:
        vmImage: ubuntu-latest
      steps:
        - checkout: self

        - script: |
            echo "Instalando dependencias..."
            npm install
          displayName: 'Instalar dependencias'

        - task: Docker@2
          displayName: 'Build and Push Docker image'
          inputs:
            command: buildAndPush
            containerRegistry: '$(dockerConnection)'
            repository: '$(imageName)'
            Dockerfile: '$(Build.SourcesDirectory)/Dockerfile'
            tags: |
              $(tag)
              latest