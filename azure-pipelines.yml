# Docker
# Build a Docker image
# https://docs.microsoft.com/azure/devops/pipelines/languages/docker

trigger:
  branches:
    include:
      - main
  batch: false

pr:
  branches:
    include:
    - main   # Se ejecuta al validar PR hacia main

variables:
  tag: '$(Build.BuildId)'
  dockerConnection: 'docker'               # service connection
  imageName: 'bernardo2004/recipes-app'    # imagen Docker Hub

stages:
# Stage 1: Validar Pull Request
- stage: Validate
  displayName: 'Validar Pull Request (sin push)'
  condition: eq(variables['Build.Reason'], 'PullRequest')
  jobs:
  - job: ValidatePR
    displayName: 'Instalar dependencias y validar build'
    pool:
      vmImage: ubuntu-latest
    steps:
    - checkout: self

    - task: NodeTool@0
      inputs:
        versionSpec: '20.x' 
      displayName: 'Usar Node.js 20'

    - script: |
        echo "Instalando dependencias..."
        npm install
        echo "Dependencias instaladas correctamente"
      displayName: 'Instalar dependencias Node.js'

    - script: |
        echo "Ejecutando pruebas..."
#        npm test || exit 1
      displayName: 'Correr pruebas autom√°ticas'

# Stage 2: Build & Push solo tras merge
- stage: BuildAndPush
  displayName: 'Build & Push Docker Image'
  condition: or(
    and(succeeded(), eq(variables['Build.Reason'], 'IndividualCI')),
    and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main')))
  jobs:
  - job: Build
    pool:
      vmImage: ubuntu-latest
    steps:
    - checkout: self
    - script: npm install
      displayName: 'Instalar dependencias'
    - task: Docker@2
      displayName: 'Build and Push Docker image'
      inputs:
        command: buildAndPush
        containerRegistry: '$(dockerConnection)'
        repository: '$(imageName)'
        Dockerfile: '$(Build.SourcesDirectory)/Dockerfile'
        tags: |
          $(tag)
          latest