trigger:
  branches:
    include:
      - dev
      - main

pr:
  branches:
    include:
      - dev

variables:
  tag: '$(Build.BuildId)'
  imageName: 'bernardo2004/recipes-proy'
  dockerConnection: 'docker'

stages:
# Stage 1: Validaci√≥n y pruebas
- stage: Validate
  displayName: 'Validar y ejecutar pruebas'
  condition: |
    or(
      eq(variables['Build.Reason'], 'PullRequest'),
      and(
        eq(variables['Build.Reason'], 'IndividualCI'),
        or(
          eq(variables['Build.SourceBranch'], 'refs/heads/dev'),
          eq(variables['Build.SourceBranchName'], 'dev')
        )
      )
    )
  jobs:
    - job: Test
      displayName: 'Ejecutar pruebas'
      pool:
        vmImage: ubuntu-latest
      steps:
        - checkout: self

        - script: |
            echo "Instalando dependencias..."
            npm install
            echo "Ejecutando pruebas..."
            npm test
          displayName: 'Instalar dependencias y correr pruebas'

# Stage 2: Build & Push Docker (solo en merge a main)
- stage: BuildAndPush
  displayName: 'Build & Push Docker Image'
  dependsOn: Validate
  condition: |
    and(
      succeeded(),
      eq(variables['Build.Reason'], 'IndividualCI'),
      or(
        eq(variables['Build.SourceBranch'], 'refs/heads/main'),
        eq(variables['Build.SourceBranchName'], 'main')
      ),
      contains(variables['Build.SourceVersionMessage'], 'Merge pull request')
    )
  jobs:
    - job: Build
      displayName: 'Construir y subir imagen Docker'
      pool:
        vmImage: ubuntu-latest
      steps:
        - checkout: self

        - script: |
            echo "Instalando dependencias..."
            npm install
          displayName: 'Instalar dependencias'

        - task: Docker@2
          displayName: 'Build and Push Docker image'
          inputs:
            command: buildAndPush
            containerRegistry: '$(dockerConnection)'
            repository: '$(imageName)'
            Dockerfile: '$(Build.SourcesDirectory)/Dockerfile'
            tags: |
              $(tag)
              latest