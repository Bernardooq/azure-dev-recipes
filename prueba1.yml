pr:
  branches:
    include:
      - main
      - dev

trigger:
  branches:
    include:
      - main

variables:
  tag: '$(Build.BuildId)'
  imageName: 'bernardo2004/recipes-proy'
  dockerConnection: 'docker'
  azureServiceConnection: 'Azure'
  resourceGroup: 'rg-practica11'
  webAppName: 'webapp-practica11'
  location: 'westus'

stages:
  - stage: Validate
    displayName: 'Validar y ejecutar pruebas'
    jobs:
      - job: Test
        displayName: 'Ejecutar pruebas y verificar coverage'
        pool:
          vmImage: ubuntu-latest
        steps:
          - checkout: self
            persistCredentials: true

          - task: NodeTool@0
            inputs:
              versionSpec: '18.x'
            displayName: 'Use Node 18'

          - script: |
              echo "Instalando dependencias..."
              npm ci
            displayName: 'Instalar dependencias'

          - script: |
              echo "Ejecutando pruebas..."
              npx jest --coverage --runInBand --forceExit --detectOpenHandles
            displayName: 'Run Jest'
          
          - task: PublishTestResults@2
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: 'test-results/jest-junit.xml'
              failTaskOnFailedTests: true
            condition: succeededOrFailed()

          - task: PublishCodeCoverageResults@2
            inputs:
              codeCoverageTool: 'Cobertura'
              summaryFileLocation: 'coverage/cobertura-coverage.xml'
              reportDirectory: 'coverage/lcov-report'

  - stage: BuildAndPush
    dependsOn: Validate
    displayName: 'Build & Push Docker Image'
    condition: and(succeeded(), ne(variables['Build.Reason'], 'PullRequest'), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - job: Build
        displayName: 'Construir y subir imagen Docker'
        pool:
          vmImage: ubuntu-latest
        steps:
          - checkout: self

          - task: NodeTool@0
            inputs:
              versionSpec: '18.x'
            displayName: 'Use Node 18'

          - script: |
              echo "Instalando dependencias..."
              npm ci
            displayName: 'Instalar dependencias'

          - task: Docker@2
            displayName: 'Build and Push Docker image'
            inputs:
              command: buildAndPush
              containerRegistry: '$(dockerConnection)'
              repository: '$(imageName)'
              Dockerfile: '$(Build.SourcesDirectory)/Dockerfile'
              tags: |
                $(tag)
                latest

  - stage: Deploy
    dependsOn: BuildAndPush
    displayName: 'Deploy to Azure Web App with Docker Image'
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - job: Deploy
        displayName: 'Deploy Docker image'
        pool:
          vmImage: ubuntu-latest
        steps:
          - task: AzureCLI@2
            displayName: 'Configure Web App to use Docker image'
            inputs:
              azureSubscription: '$(azureServiceConnection)'
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                echo "Configurando Web App para usar la imagen Docker..."
                
                az webapp config container set \
                  --resource-group $(resourceGroup) \
                  --name $(webAppName) \
                  --docker-custom-image-name $(imageName):latest \
                  --docker-registry-server-url https://index.docker.io/v1/

                echo "Reiniciando Web App..."
                az webapp restart \
                  --resource-group $(resourceGroup) \
                  --name $(webAppName)

                echo "DEPLOY COMPLETADO con imagen Docker."